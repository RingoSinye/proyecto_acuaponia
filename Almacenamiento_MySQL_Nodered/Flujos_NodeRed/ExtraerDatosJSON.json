[
    {
        "id": "2ad38da3cbb276d2",
        "type": "function",
        "z": "45bf3cd9ae0624aa",
        "name": "ExtraerDatosJSON",
        "func": "// El mensaje completo del Sparkplug B\nlet data = msg.payload;\nlet timestamp = data.timestamp;\nlet results = [];\n\n// Validación básica\nif (!data.metrics) {\n    node.warn(\"No hay métricas en el payload\");\n    return null;\n}\n\n// Recorrer jerarquía principal\nfor (let mod of data.metrics) {\n    let modulo = mod.name || \"unknown\";\n\n    if (!mod.templateValue || !mod.templateValue.metrics) continue;\n\n    // Recorrer los submódulos del módulo (GrowBed, FishTank, etc.)\n    for (let sub of mod.templateValue.metrics) {\n        let submodulo = sub.name || \"none\";\n\n        if ((!sub.templateValue || !sub.templateValue.metrics) &&\n            sub.floatValue === undefined) continue;\n\n        // ============================\n        //    CASO 1: GROWBED\n        // ============================\n        if (submodulo === 'AquaponicGrowBed') {\n            for (let device of sub.templateValue.metrics) {\n                let deviceName = device.name || \"device\";\n                let template = device.templateValue;\n                if (!template || !template.metrics) continue;\n\n                // --- A) ACTUADORES ---\n                if (template.templateRef === 'Actuadores') {\n                    let datosAct = {};\n                    for (let m of template.metrics) {\n                        datosAct[m.name] =\n                            m.floatValue ?? m.booleanValue ?? m.stringValue ?? null;\n                    }\n\n                    results.push({\n                        timestamp,\n                        modulo,\n                        submodulo,\n                        dispositivo: deviceName,\n                        descripcion: datosAct[\"Desc\"] ?? \"\",\n                        start: datosAct[\"Start\"] ?? 0,\n                        stop: datosAct[\"Stop\"] ?? 0,\n                        valstatus: datosAct[\"ValStatus\"] ?? 0,\n                        fault: datosAct[\"Fault\"] ?? 0\n                    });\n                }\n\n                // --- B) SENSORES DIGITALES ---\n                else if (template.templateRef === 'Digital_Sensors') {\n\n                    // Buscamos el valor PV (true/false → 1/0)\n                    let pvMetric = template.metrics.find(m => m.name === \"PV\");\n                    let pv = null;\n\n                    if (pvMetric && pvMetric.booleanValue !== undefined) {\n                        pv = pvMetric.booleanValue ? 1 : 0;\n                    }\n\n                    results.push({\n                        timestamp,\n                        modulo,\n                        submodulo,\n                        dispositivo: deviceName,\n                        tipo: \"digital\",\n                        variable: \"PV\",\n                        valor: pv\n                    });\n                }\n\n                // --- C) SENSORES ANALÓGICOS ---\n                else {\n                    for (let m of template.metrics) {\n                        let variable = m.name;\n                        let value = m.floatValue ?? m.booleanValue ?? m.stringValue ?? null;\n\n                        results.push({\n                            timestamp,\n                            modulo,\n                            submodulo,\n                            dispositivo: deviceName,\n                            tipo: \"analogico\",\n                            variable,\n                            valor: value\n                        });\n                    }\n                }\n            }\n        }\n\n        // ============================\n        //    CASO 2: FISH TANK\n        // ============================\n        else if (submodulo === 'FishTank') {\n            for (let device of sub.templateValue.metrics) {\n                let deviceName = device.name || \"device\";\n                let template = device.templateValue;\n                if (!template || !template.metrics) continue;\n\n                // --- A) ACTUADORES ---\n                if (template.templateRef === 'Actuadores') {\n                    let datosAct = {};\n                    for (let m of template.metrics) {\n                        datosAct[m.name] =\n                            m.floatValue ?? m.booleanValue ?? m.stringValue ?? null;\n                    }\n\n                    results.push({\n                        timestamp,\n                        modulo,\n                        submodulo,\n                        dispositivo: deviceName,\n                        descripcion: datosAct[\"Desc\"] ?? \"\",\n                        start: datosAct[\"Start\"] ?? 0,\n                        stop: datosAct[\"Stop\"] ?? 0,\n                        valstatus: datosAct[\"ValStatus\"] ?? 0,\n                        fault: datosAct[\"Fault\"] ?? 0\n                    });\n                }\n\n                // --- B) SENSORES DIGITALES ---\n                else if (template.templateRef === 'Digital_Sensors') {\n\n                    let pvMetric = template.metrics[0];\n                    let pv = null;\n\n                    if (pvMetric && pvMetric.booleanValue !== undefined) {\n                        pv = pvMetric.booleanValue ? 1 : 0;\n                    }\n\n                    results.push({\n                        timestamp,\n                        modulo,\n                        submodulo,\n                        dispositivo: deviceName,\n                        tipo: \"digital\",\n                        variable: \"PV\",\n                        valor: pv\n                    });\n                }\n\n                // --- C) SENSORES ANALÓGICOS ---\n                else {\n                    for (let m of template.metrics) {\n                        let variable = m.name;\n                        let value = m.floatValue ?? m.booleanValue ?? m.stringValue ?? null;\n\n                        results.push({\n                            timestamp,\n                            modulo,\n                            submodulo,\n                            dispositivo: deviceName,\n                            tipo: \"analogico\",\n                            variable,\n                            valor: value\n                        });\n                    }\n                }\n            }\n        }\n\n        // ============================\n        //    CASO 3: MATERIA PRIMA\n        // ============================\n        else if (sub.name === \"Fish\" || sub.name === \"Vegetables\") {\n            let materia_prima = sub.name === \"Fish\" ? \"Peces\" : \"Vegetales\";\n            let cantidad = sub.floatValue ?? 0;\n\n            results.push({\n                timestamp,\n                modulo,\n                materia_prima,\n                cantidad\n            });\n        }\n    }\n}\n\n// Resultado final\nmsg.payload = results;\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 620,
        "wires": [
            [
                "7f26ad91153946f3",
                "7b8901693534a13c"
            ]
        ]
    }
]